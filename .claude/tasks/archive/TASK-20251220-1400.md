# Task: voidauth Kubernetes Manifest構築

**Started:** 2025-12-20
**Status:** In Progress

## 概要

voidauth (https://github.com/voidauth/voidauth) をKubernetesクラスタ上にデプロイするためのマニフェストを構築する。

## アプリケーション仕様

- **名前:** voidauth
- **機能:** OpenID Connect (OIDC) プロバイダー、Proxy ForwardAuth対応
- **イメージ:** voidauth/voidauth:latest
- **ポート:** 3000
- **データベース:** PostgreSQL 18
- **必須環境変数:**
  - APP_URL: アプリケーションURL
  - STORAGE_KEY: 暗号化用キー
  - DB_HOST: データベースホスト
  - DB_PASSWORD: データベースパスワード
- **ボリューム:** /app/config
- **公開方法:** Cloudflare Tunnel（外部公開）

## タスク進捗

### Phase 1: 調査と準備
- [x] voidauthのGitHubリポジトリを調査
- [x] compose.ymlと.example.envを確認
- [x] CURRENT_TASK.mdを作成

### Phase 2: Kubernetesマニフェスト作成
- [x] マニフェストディレクトリ作成
- [x] namespace.yaml作成
- [x] PostgreSQL 18データベース（CNPG）設定
- [x] 1Password OperatorでシークレットItem作成
- [x] Deployment作成
- [x] Service作成
- [x] Cloudflare Tunnel Ingress作成
- [x] PersistentVolumeClaim作成
- [x] kustomization.yaml作成

### Phase 3: ArgoCD統合
- [x] ArgoCD Application作成
- [x] argocd-apps/kustomization.yamlに追加

### Phase 4: 検証
- [x] マニフェスト構文チェック
- [x] YAML形式チェック (yamlfmt)

## 決定事項

1. **PostgreSQLバージョン:** 18（voidauth推奨）
2. **StorageClass:** nfs-client（標準）
3. **公開方法:** Cloudflare Tunnel（ユーザー選択）
4. **ホスト名:** auth.harvestasya.org
5. **Namespace:** voidauth
6. **環境変数:** すべてsecretKeyRefで定義（セキュリティ要件）

## 次のステップ（デプロイ前の手順）

1. **1Passwordに以下のItemを作成する必要があります:**

   a. `voidauth-db` (itemPath: vaults/5mixaulvwor6zfvbfmtqlksdy4/items/voidauth-db)
      - `host`: voidauth-database-rw
      - `database`: voidauth
      - `username`: voidauth
      - `password`: <自動生成パスワード>

   b. `voidauth` (itemPath: vaults/5mixaulvwor6zfvbfmtqlksdy4/items/voidauth)
      - `APP_URL`: https://auth.harvestasya.org
      - `STORAGE_KEY`: <ランダムな暗号化キー>

2. **リポジトリにpushしてデプロイ:**
   - git add & commit & push
   - ArgoCDが自動的にsync（2-3分以内）

3. **デプロイ後の確認:**
   - kubectl get pods -n voidauth
   - kubectl logs -n voidauth <voidauth-pod> で初期管理者認証情報を確認
   - https://auth.harvestasya.org にアクセス可能か確認

## Modified Files

### 新規作成
1. `freesia/manifests/voidauth/namespace.yaml` - voidauth namespace
2. `freesia/manifests/voidauth/cnpg-cluster.yaml` - PostgreSQL 18 database
3. `freesia/manifests/voidauth/secret-voidauth-db.yaml` - DB secrets (1Password)
4. `freesia/manifests/voidauth/secret-voidauth.yaml` - App secrets (1Password)
5. `freesia/manifests/voidauth/pvc.yaml` - Config storage PVC
6. `freesia/manifests/voidauth/deployment.yaml` - voidauth deployment
7. `freesia/manifests/voidauth/service.yaml` - voidauth service
8. `freesia/manifests/voidauth/ingress.yaml` - Cloudflare Tunnel ingress
9. `freesia/manifests/voidauth/kustomization.yaml` - Kustomize config
10. `freesia/manifests/argocd-apps/voidauth.yaml` - ArgoCD Application

### 変更
1. `freesia/manifests/argocd-apps/kustomization.yaml` - voidauth.yaml追加

## Blockers

（なし）
