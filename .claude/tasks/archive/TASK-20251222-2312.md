# Task: Google Workspace Terraform Module 最新化

**開始時刻**: 2025-12-22
**ステータス**: In Progress

## 目的
terraform/modules/googleworkspace の Google Workspace ドメイン設定を最新化し、再利用可能なモジュールとして整備する。

## 現状分析

### 発見された問題点
1. **変数名の不整合**
   - `variables.tf` では `cloudflare_dns_zone_id` と定義
   - `main.tf` では `var.zone_id` を参照（定義なし）

2. **不足している変数定義**
   - `domain_verify_txt` が `main.tf` で使用されているが、`variables.tf` に定義なし

3. **型定義の問題**
   - TTL が文字列 `"1"` で定義（数値が適切）
   - proxied が文字列 `"false"` で定義（booleanが適切）

4. **モジュール構造の不足**
   - `outputs.tf` がない
   - ドキュメント（README.md）がない

### 現在のファイル構成
- `main.tf` - MXレコード5つ、TXTレコード2つ（SPF、ドメイン検証）
- `versions.tf` - Cloudflare provider 5.14.0, Terraform 1.14.3
- `variables.tf` - 変数定義（不整合あり）

## 実行計画

### Phase 1: 変数定義の修正
- [x] 既存コードの確認
- [ ] variables.tf の修正（zone_id, domain_verify_txtの追加）
- [ ] 型定義の修正（number, boolean）

### Phase 2: Google Workspace ベストプラクティス確認
- [ ] 最新のGoogle Workspace DNS要件を調査
- [ ] 必要に応じてレコード定義を更新

### Phase 3: モジュール化
- [ ] outputs.tf の作成
- [ ] README.md の作成

### Phase 4: 検証と整形
- [ ] terraform fmt 実行
- [ ] 構文チェック

## 進捗状況

### 完了したステップ
- 既存コードの読み込みと問題点の特定
- Google Workspace DNS要件の調査（2025年最新情報）
- variables.tf の修正（型定義、変数追加）
- main.tf の修正（TTL/priority型修正、DKIM/DMARC追加）
- outputs.tf の作成
- README.md の作成
- terraform fmt による整形

### 現在作業中
- タスク完了処理

### 次のステップ
- なし（タスク完了）

## 変更ファイル
- `terraform/modules/googleworkspace/variables.tf` - 変数定義の修正と拡張
- `terraform/modules/googleworkspace/main.tf` - 型修正とDKIM/DMARC追加
- `terraform/modules/googleworkspace/outputs.tf` - 新規作成
- `terraform/modules/googleworkspace/README.md` - 新規作成

## 決定事項
- `cloudflare_dns_zone_id` を正式な変数名として採用
- Cloudflare provider 5.14.0 を維持（すでに最新）
- Terraform 1.14.3 を維持
- MXレコードはレガシー形式（5レコード）を維持（2025年も引き続きサポート）
- TTLデフォルト値を3600秒に設定（Googleの推奨値）
- DKIM/DMARCレコードをオプションとして追加
- 型を適切に修正（TTL: number, priority: number, proxied削除）

## 主な改善点
1. **変数定義の修正**
   - 不整合の解消（cloudflare_dns_zone_idで統一）
   - 不足変数の追加（domain_verify_txt）
   - 型定義の適正化（TTL: number）
   - 新規変数追加（DKIM, DMARC対応）

2. **メール認証の強化**
   - DKIM レコード対応（オプション）
   - DMARC レコード対応（オプション）
   - SPF レコードの有効化フラグ追加

3. **モジュール化**
   - outputs.tf による出力定義
   - 詳細なドキュメント（README.md）

4. **ベストプラクティス準拠**
   - TTL 3600秒（Googleの推奨値）
   - 適切なコメント追加
   - Terraform標準形式準拠

## ブロッカー
- なし
