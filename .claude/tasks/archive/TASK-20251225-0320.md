# Task: AdGuardHome ACME自動証明書更新

**開始時刻**: 2025-12-25 02:00 UTC
**完了時刻**: 2025-12-25 03:20 UTC
**ステータス**: ✅ Completed

## 目的

VM上のAdGuardHome（`adguard.ssa.suzutan.jp`）のTLS証明書をACMEプロトコルで自動更新できるようにする。

## 前提条件

### 既存環境
- **AdGuardHome VM**: `172.20.0.200`（Ubuntu/Debian）
- **step-ca**: Kubernetes上で稼働中（step-ca namespace）
- **Cloudflare DNS**: `harvestasya.org`ゾーン管理
- **PowerDNS**: LAN内DNS（`ssa.suzutan.jp`ゾーン管理）
- **現在の証明書**: 手動設定（AdGuardHome.yamlに直接記載）

### 目標
- ✅ step-ca ACME経由で証明書を自動取得
- ✅ 証明書の自動更新（acme.sh cron）
- ✅ AdGuardHomeの自動再起動

## タスクフェーズ

### Phase 1: LoadBalancer実装 ✅
- [x] MetalLB L2 Advertisement問題の発見（異なるVLAN間での制限）
- [x] kube-vip調査と実装方針決定
- [x] kube-vip DaemonSet作成（ARP mode）
- [x] kube-vip Cloud Provider作成
- [x] IP範囲設定（172.20.2.201-250）
- [x] MetalLB無効化
- [x] step-certificates LoadBalancer Service作成
- [x] IP割り当て確認（172.20.2.201取得成功）

### Phase 2: DNS設定 ✅
- [x] Cloudflare DNSで`acme.harvestasya.org` A record追加（172.20.2.201）
- [x] DNS解決確認

### Phase 3: CoreDNS設定 ✅
- [x] Kubernetes内部DNS解決問題の発見
- [x] CoreDNS hostsプラグイン追加
- [x] `adguard.ssa.suzutan.jp` → `172.20.0.200` 静的エントリ追加
- [x] CoreDNS再起動と動作確認

### Phase 4: VM上でACMEクライアント設定 ✅
- [x] step-ca Root CA証明書取得・信頼設定
- [x] acme.shインストール
- [x] socatインストール（standalone mode用）
- [x] AdGuardHome Web UIポート変更（80 → 3000）
- [x] ACME HTTP-01チャレンジで証明書取得成功

### Phase 5: AdGuardHome証明書設定 ✅
- [x] 証明書インストール（`/opt/AdGuardHome/certs/`）
- [x] AdGuardHome.yaml設定変更（証明書ファイルパス参照）
- [x] HTTPS接続確認（TLS 1.3、証明書検証OK）
- [x] acme.sh自動更新テスト（強制更新成功）
- [x] cron設定確認（毎日1:05 UTC）

## 実装詳細

### Decisions Made

#### LoadBalancer実装
- **MetalLB → kube-vip**: L2 Advertisementが異なるVLAN間で動作しないため、kube-vipに変更
- **kube-vip ARP mode**: 172.20.2.0/24内でARP、ルーティングで172.20.0.0/24からアクセス可能

#### ACME Challenge方式
- **HTTP-01**: step-ca LoadBalancer経由でアクセス可能
- **Standalone mode**: AdGuardHomeのポート80を空けて使用

#### ACMEクライアント
- **acme.sh**: 軽量、cron対応、hook script対応
- **certbot**: Python依存関係が多いためVM環境には不適

#### ドメイン名
- **ACME CA**: `acme.harvestasya.org` → 172.20.2.201（kube-vip LoadBalancer）
- **AdGuardHome**: `adguard.ssa.suzutan.jp` → 172.20.0.200

#### 証明書配置
- `/opt/AdGuardHome/certs/cert.pem`（証明書）
- `/opt/AdGuardHome/certs/key.pem`（秘密鍵）
- `/opt/AdGuardHome/certs/fullchain.pem`（フルチェーン）
- AdGuardHome.yamlは証明書ファイルパスを参照

### 技術的課題と解決策

#### 課題1: MetalLB L2 Advertisement
- **問題**: AdGuardHome VM（172.20.0.0/24）とKubernetes（172.20.2.0/24）が異なるVLAN
- **原因**: ARPは同一L2セグメント内でのみ動作
- **解決**: kube-vipに変更（ARP + ルーティング）

#### 課題2: Kubernetes内部DNS解決
- **問題**: step-caから`adguard.ssa.suzutan.jp`を解決できない
- **原因**: CoreDNSがPowerDNS（AdGuardHome）を上流DNSとして使用していない
- **解決**: CoreDNS hostsプラグインで静的エントリ追加

#### 課題3: AdGuardHomeのポート競合
- **問題**: acme.sh standaloneモードがポート80を必要とするが、AdGuardHomeが使用
- **解決**: AdGuardHome Web UIを3000ポートに変更

## Modified Files

### Kubernetes Manifests
- `freesia/manifests/kube-vip/rbac.yaml` - kube-vip RBAC設定
- `freesia/manifests/kube-vip/daemonset.yaml` - kube-vip DaemonSet（ARP mode）
- `freesia/manifests/kube-vip/cloud-provider.yaml` - kube-vip Cloud Provider
- `freesia/manifests/kube-vip/configmap.yaml` - IP範囲設定（172.20.2.201-250）
- `freesia/manifests/kube-vip/kustomization.yaml` - Kustomize設定
- `freesia/manifests/argocd-apps/kube-vip.yaml` - ArgoCD Application
- `freesia/manifests/argocd-apps/kustomization.yaml` - kube-vip追加、MetalLB削除
- `freesia/manifests/step-ca/service-loadbalancer.yaml` - step-ca LoadBalancer Service

### Terraform
- `terraform/harvestasya.org/dns.tf` - acme.harvestasya.org A record（172.20.2.201）

### Kubernetes ConfigMap（手動変更）
- `kube-system/coredns` - hostsプラグイン追加（adguard.ssa.suzutan.jp → 172.20.0.200）

### AdGuardHome VM（手動設定）
- `/opt/AdGuardHome/AdGuardHome.yaml` - 証明書ファイルパス参照、Web UIポート3000
- `/opt/AdGuardHome/certs/` - 証明書ディレクトリ作成
- `/root/.acme.sh/` - acme.sh設定
- `/etc/cron.d/` - acme.sh cron（毎日1:05 UTC）

### 1Password
- `ca.json`（UUID: 2n33wjnxjubdch4z4im4y75xb4）- ACME provisioner追加、acme.harvestasya.org追加

## 最終構成

```
AdGuardHome VM (172.20.0.200)
    ↓ DNS: adguard.ssa.suzutan.jp
    ↓ HTTPS: 443
    ↓ Web UI: 3000
    ↓
acme.sh (cron: 毎日1:05 UTC)
    ↓ ACME HTTP-01
    ↓
step-ca (Kubernetes) ← LoadBalancer (kube-vip: 172.20.2.201)
    ↑ DNS: acme.harvestasya.org
    ↑
Cloudflare DNS (A record)
```

### 証明書情報
- **発行者**: Harvestasya Intermediate CA
- **有効期限**: 30日
- **自動更新**: 有効期限の約2/3経過時点（約20日後）
- **更新方法**: acme.sh cron → 証明書取得 → ファイル更新 → AdGuardHome再起動

## 参照リソース
- [step-ca ACME](https://smallstep.com/docs/step-ca/acme-basics/)
- [acme.sh](https://github.com/acmesh-official/acme.sh)
- [kube-vip](https://kube-vip.io/)

## 検証結果

### HTTPS接続確認
```bash
echo | openssl s_client -connect adguard.ssa.suzutan.jp:443
# Verify return code: 0 (ok)
# TLS 1.3, Cipher is TLS_AES_128_GCM_SHA256
```

### 証明書自動更新テスト
```bash
acme.sh --renew -d adguard.ssa.suzutan.jp --ecc --force
# [Thu Dec 25 03:20:30 UTC 2025] Reload successful
```

### cron設定
```bash
crontab -l | grep acme.sh
# 5 1 * * * "/root/.acme.sh"/acme.sh --cron --home "/root/.acme.sh" > /dev/null
```

## 今後の運用

### 監視項目
- acme.sh cronログ（`/root/.acme.sh/*.log`）
- AdGuardHome HTTPS接続（証明書有効期限）
- kube-vip LoadBalancer Service（IP: 172.20.2.201）

### メンテナンス
- 証明書は自動更新されるため、通常メンテナンス不要
- step-ca pod再作成時は証明書更新に影響なし（LoadBalancer IPが維持される限り）
- AdGuardHome VM再起動後も自動的にHTTPSで起動

## 結論

AdGuardHomeのTLS証明書がACMEプロトコルで自動更新されるように構成完了。
- ✅ kube-vipによるLoadBalancer実装
- ✅ step-ca ACME provisioner経由での証明書発行
- ✅ acme.shによる自動更新（cron）
- ✅ AdGuardHome自動再起動
