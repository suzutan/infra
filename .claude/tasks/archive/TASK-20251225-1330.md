# Current Task

## Metadata
- **Task ID:** TASK-20251225-1330
- **Started:** 2025-12-25 13:00
- **Last Updated:** 2025-12-25 13:50
- **Status:** completed

## Request
Proxmox (pve-root-ca.pem) の証明書を Harvestasya Root CA 配下に統一したい。step-ca が動いている K8s が Proxmox VM 上で動いているため、循環参照を避ける必要がある。

## Objective
- Proxmox 用のオフライン Intermediate CA（Harvestasya Infra CA）を作成
- Proxmox の証明書を Harvestasya Root CA 配下に統一
- Cloudflare Tunnel の TLS 検証を有効化

## Context
- Harvestasya Root CA は YubiKey に秘密鍵がある
- 既存の Harvestasya Intermediate CA は step-ca で K8s/アプリ用に使用
- Proxmox は Cloudflare Access + Tunnel 経由でアクセス（vista.harvestasya.org）
- 内部 IP: 172.20.0.204 (pve02.ssa.suzutan.jp)
- 循環参照を避けるため、step-ca とは独立したオフライン Infra CA が必要

## Plan
### Phase 1: CA 設計
- [x] 現状の CA 構成確認
- [x] Infra CA の命名規則検討（「Intermediate」は入れない慣例）

### Phase 2: Infra CA 作成（Windows + YubiKey）
- [x] Harvestasya Infra CA 作成（step コマンド + YubiKey）
- [x] Proxmox 用リーフ証明書発行（SAN: localhost, pve02.ssa.suzutan.jp, 172.20.0.204）

### Phase 3: Proxmox 設定
- [x] Root CA を Proxmox に信頼させる（update-ca-certificates）
- [x] Infra CA を Proxmox に信頼させる
- [x] pveproxy-ssl に証明書配置（pve-ssl ではなくカスタム用）
- [x] cloudflared 再起動

### Phase 4: Terraform 更新
- [x] tunnel_pve.tf から no_tls_verify 削除
- [x] origin_server_name 追加
- [x] terraform apply

### Phase 5: 保管
- [x] Infra CA を 1Password に保存

## Progress Log
### 2025-12-25 13:00
- 現状の CA 構成確認（Root CA: YubiKey、Intermediate CA: step-ca）
- Proxmox の Tunnel 設定確認（no_tls_verify = true）

### 2025-12-25 13:15
- Infra CA の設計決定：オフライン中間 CA として step-ca とは独立運用
- CN 命名規則：「Intermediate」は入れず用途を示す（Harvestasya Infra CA）

### 2025-12-25 13:25
- Windows PowerShell で Harvestasya Infra CA 作成（step コマンド + YubiKey）
- Proxmox 用リーフ証明書発行

### 2025-12-25 13:35
- Proxmox に Root CA/Infra CA 追加（update-ca-certificates）
- pveproxy-ssl.pem/key 配置
- 証明書チェーン検証 OK

### 2025-12-25 13:45
- cloudflared 再起動漏れで Bad Gateway 発生
- cloudflared 再起動後、正常動作確認
- Terraform apply 完了

## Modified Files
| File | Action | Status |
|------|--------|--------|
| terraform/harvestasya.org/tunnel_pve.tf | Modified | Done |

## Decisions Made
| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| pveproxy-ssl を使用（pve-ssl ではなく） | Proxmox 自動管理と競合しない | pve-ssl 直接変更はリスクあり |
| Infra CA をオフライン運用 | 循環参照回避、長期証明書発行可能 | step-ca で発行（循環参照リスク） |
| CN に「Intermediate」を入れない | 商用 CA の慣例に従う | Harvestasya Intermediate Infra CA |

## Blockers / Open Questions
None

## Next Steps
1. 証明書の有効期限監視を検討（1年後に更新必要）
2. 他のインフラ機器にも Infra CA から証明書発行を検討

## Notes
- Proxmox 証明書の CN は「Proxmox VE」になっている（作成時の設定）
- cloudflared はシステム CA ストアを使用するため、CA 追加後に再起動が必要
- Infra CA は 1Password に保存済み
