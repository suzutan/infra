# Current Task

## Metadata
- **Task ID:** TASK-20260201-0000
- **Started:** 2026-02-01 00:00
- **Last Updated:** 2026-02-02 00:00
- **Status:** completed

## Request
Traefik + Authentik forward authからPomerium Ingressへの移行により、完全なBeyondCorpアーキテクチャを実現する。すべてのHTTPトラフィックをPomerium経由とし、adminグループのみアクセス可能とする。

## Objective
1. Pomerium基盤をKubernetesにデプロイ
2. Traefik→Pomeriumルーティング設定
3. 10個のアプリケーションをPomerium Ingress経由に移行
4. 旧IngressRoute（Authentik forward-auth）を削除
5. 全アプリでadminグループ限定アクセスを実現

## Context
- Keycloakが既にIdPとして稼働中（qualia.harvestasya.org）
- 既存のAuthentik forward-authを置き換え
- Immich、Keycloakは除外（ループ回避・アプリ制約）

## Plan

### Phase 1: Pomerium基盤構築
- [x] namespace.yaml作成
- [x] kustomization.yaml作成
- [x] pomerium-crd.yaml作成（Global config）
- [x] onepassworditem-pomerium-idp.yaml作成
- [x] onepassworditem-pomerium-secrets.yaml作成
- [x] certificate-authenticate.yaml作成
- [x] taskfile.yaml作成
- [x] ArgoCD Application作成

### Phase 2: Traefik設定
- [x] pomerium-proxy.yaml作成（Traefik→Pomeriumルーティング）
- [x] traefik-api-service.yaml作成（Dashboard用Service）

### Phase 3: Pomerium Ingress作成（10アプリ）
- [x] navidrome/ingress-pomerium.yaml
- [x] navidrome/ingress-pomerium-filebrowser.yaml
- [x] temporis/prometheus/ingress-pomerium.yaml
- [x] temporis/grafana/ingress-pomerium.yaml
- [x] temporis/influxdb/ingress-pomerium.yaml
- [x] kubevela/ingress-pomerium-velaux.yaml
- [x] asf/ingress-pomerium.yaml
- [x] traefik/ingress-pomerium-dashboard.yaml
- [x] argocd/ingress-pomerium.yaml
- [x] n8n/ingress-pomerium.yaml

### Phase 4: 旧設定削除
- [x] navidrome/ingressroute-navidrome.yaml削除
- [x] navidrome/ingressroute-filebrowser.yaml削除
- [x] temporis/prometheus/ingressroute.yaml削除
- [x] temporis/grafana/ingressroute.yaml削除
- [x] traefik/config/routes/dashboard.yaml削除
- [x] kubevela/ingressroute-velaux.yaml削除
- [x] argocd/ingressroute.yaml削除
- [x] n8n/ingressroute.yaml削除
- [x] asf/application.yaml修正（traefik-route削除）

### Phase 5: kustomization.yaml更新
- [x] 各ディレクトリのkustomization.yaml更新

### Phase 6: フォーマット・検証
- [x] yamlfmt実行

## Progress Log

### 2026-02-01 00:00
- タスク開始
- 既存Keycloak移行タスクをアーカイブ

### 2026-02-02 00:00
- Phase 1-6 完了確認
- asf/application.yaml からtraefik-routeトレイト削除
- yamlfmt実行

## Modified Files

| File | Action | Status |
|------|--------|--------|
| k8s/manifests/pomerium/* | Created | ✓ |
| k8s/manifests/argocd-apps/pomerium.yaml | Created | ✓ |
| k8s/manifests/traefik/config/routes/pomerium-proxy.yaml | Created | ✓ |
| k8s/manifests/traefik/traefik-api-service.yaml | Created | ✓ |
| k8s/manifests/traefik/ingress-pomerium-dashboard.yaml | Created | ✓ |
| k8s/manifests/navidrome/ingress-pomerium.yaml | Created | ✓ |
| k8s/manifests/navidrome/ingress-pomerium-filebrowser.yaml | Created | ✓ |
| k8s/manifests/temporis/prometheus/ingress-pomerium.yaml | Created | ✓ |
| k8s/manifests/temporis/grafana/ingress-pomerium.yaml | Created | ✓ |
| k8s/manifests/temporis/influxdb/ingress-pomerium.yaml | Created | ✓ |
| k8s/manifests/kubevela/ingress-pomerium-velaux.yaml | Created | ✓ |
| k8s/manifests/asf/ingress-pomerium.yaml | Created | ✓ |
| k8s/manifests/argocd/ingress-pomerium.yaml | Created | ✓ |
| k8s/manifests/n8n/ingress-pomerium.yaml | Created | ✓ |
| k8s/manifests/navidrome/ingressroute-navidrome.yaml | Deleted | ✓ |
| k8s/manifests/navidrome/ingressroute-filebrowser.yaml | Deleted | ✓ |
| k8s/manifests/temporis/prometheus/ingressroute.yaml | Deleted | ✓ |
| k8s/manifests/temporis/grafana/ingressroute.yaml | Deleted | ✓ |
| k8s/manifests/traefik/config/routes/dashboard.yaml | Deleted | ✓ |
| k8s/manifests/kubevela/ingressroute-velaux.yaml | Deleted | ✓ |
| k8s/manifests/argocd/ingressroute.yaml | Deleted | ✓ |
| k8s/manifests/n8n/ingressroute.yaml | Deleted | ✓ |
| k8s/manifests/asf/application.yaml | Modified | ✓ |
| k8s/manifests/*/kustomization.yaml | Modified | ✓ |

## Decisions Made

| Decision | Rationale | Alternatives Considered |
|----------|-----------|------------------------|
| 全HTTPトラフィックをPomerium経由 | BeyondCorpアーキテクチャ実現 | アプリ単位でforward-auth |
| Keycloak除外 | IdPループ回避 | N/A |
| Immich除外 | iOSアプリがOIDC非対応 | N/A |
| adminグループ限定 | 統一的なアクセス制御 | アプリ別グループ |

## Blockers / Open Questions

- [x] 1PasswordにPomerium用シークレット作成（手動作業）- 完了前提
- [x] KeycloakにPomerium OIDCクライアント作成（手動作業）- 完了前提

## Next Steps

1. git commit & push
2. ArgoCD sync確認
3. 動作検証（各アプリへのアクセス確認）

## Notes

### 移行対象アプリケーション（10個）
1. Navidrome - navidrome.harvestasya.org
2. FileBrowser - navidrome-filebrowser.harvestasya.org
3. ASF - asf.harvestasya.org
4. VelaUX - velaux.harvestasya.org
5. Traefik Dashboard - traefik.harvestasya.org
6. Prometheus - prometheus.harvestasya.org
7. ArgoCD - argocd.harvestasya.org
8. Grafana - grafana.harvestasya.org
9. N8N - reyvateils.harvestasya.org
10. InfluxDB2 - influxdb2.harvestasya.org

### 除外
- Keycloak（qualia.harvestasya.org）- IdP、ループ回避
- Keycloak Admin（qualia-admin.harvestasya.org）- Cloudflare Access保護
- Immich（chronicle.harvestasya.org）- iOSアプリ制約

### 廃止予定
- Authentik（authentik.harvestasya.org）- 移行完了後削除
