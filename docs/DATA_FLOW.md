# Data Flow

このドキュメントは、HomeLab環境のデータフローを説明します。

## GitOps デプロイフロー

```
┌─────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Developer  │     │     GitHub      │     │    Renovate     │
│             │────▶│   Repository    │◀────│  (Auto Update)  │
└─────────────┘     └────────┬────────┘     └─────────────────┘
                             │
                             │ Webhook / Polling
                             ▼
                    ┌─────────────────┐
                    │     ArgoCD      │
                    │                 │
                    │  ┌───────────┐  │
                    │  │  Sync     │  │
                    │  │  Engine   │  │
                    │  └─────┬─────┘  │
                    └────────┼────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │   Kubernetes    │
                    │    Cluster      │
                    │                 │
                    │  ┌───────────┐  │
                    │  │  Apply    │  │
                    │  │ Manifests │  │
                    │  └───────────┘  │
                    └─────────────────┘
```

### フロー詳細

1. **コード変更**: 開発者がリポジトリにプッシュ
2. **自動更新**: Renovateが依存関係を検出・PR作成
3. **マージ**: 自動マージまたは手動承認
4. **同期検知**: ArgoCDがGitの変更を検知 (3分間隔)
5. **自動同期**: マニフェストをクラスタに適用
6. **検証**: ヘルスチェックで状態確認

## 認証フロー

### Authentik OIDC

```
┌──────────┐     ┌───────────────┐     ┌─────────────┐
│   User   │────▶│  Application  │────▶│  Authentik  │
└──────────┘     │   (ArgoCD)    │     │    (IdP)    │
                 └───────────────┘     └──────┬──────┘
                                              │
                        ┌─────────────────────┘
                        │
                        ▼
                 ┌───────────────┐
                 │  1Password    │
                 │    Vault      │
                 │  (Secrets)    │
                 └───────────────┘
```

### Forward Auth (Traefik)

```
┌──────────┐     ┌───────────────┐     ┌─────────────────┐
│   User   │────▶│    Traefik    │────▶│    Authentik    │
└──────────┘     │   (Ingress)   │     │  (Forward Auth) │
                 └───────┬───────┘     └────────┬────────┘
                         │                      │
                         │   ◀──── Auth OK ─────┘
                         │
                         ▼
                 ┌───────────────┐
                 │  Application  │
                 │  (Navidrome)  │
                 └───────────────┘
```

### Cloudflare Zero Trust

```
┌──────────┐     ┌───────────────┐     ┌─────────────────┐
│   User   │────▶│   Cloudflare  │────▶│    Authentik    │
└──────────┘     │  Zero Trust   │     │    (OIDC)       │
                 └───────┬───────┘     └────────┬────────┘
                         │                      │
                         │   ◀── Identity ──────┘
                         │
                         ▼
                 ┌───────────────┐
                 │   Cloudflare  │
                 │    Tunnel     │
                 └───────┬───────┘
                         │
                         ▼
                 ┌───────────────┐
                 │  Application  │
                 │    (SSH)      │
                 └───────────────┘
```

## シークレット配布フロー

```
┌─────────────────┐
│   1Password     │
│     Vault       │
│                 │
│  ┌───────────┐  │
│  │  Secret   │  │
│  │  Items    │  │
│  └─────┬─────┘  │
└────────┼────────┘
         │
         │ API (Connect Server)
         ▼
┌─────────────────┐
│   1Password     │
│   Operator      │
│                 │
│  ┌───────────┐  │
│  │  Watch    │  │
│  │  OnePass  │  │
│  │  Item CRD │  │
│  └─────┬─────┘  │
└────────┼────────┘
         │
         │ Create/Update
         ▼
┌─────────────────┐
│   Kubernetes    │
│    Secret       │
│                 │
│  ┌───────────┐  │
│  │  secret-  │  │
│  │  <name>   │  │
│  └─────┬─────┘  │
└────────┼────────┘
         │
         │ Mount / Env
         ▼
┌─────────────────┐
│   Application   │
│      Pod        │
└─────────────────┘
```

## 監視データフロー

```
┌─────────────────────────────────────────────────────────────────┐
│                     Data Collection                              │
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │Node-Exporter│  │Remo-Exporter│  │   kube-state-metrics    │  │
│  │ (DaemonSet) │  │(Nature Remo)│  │      (kube-system)      │  │
│  └──────┬──────┘  └──────┬──────┘  └────────────┬────────────┘  │
│         │                │                      │               │
└─────────┼────────────────┼──────────────────────┼───────────────┘
          │                │                      │
          └────────────────┼──────────────────────┘
                           │
                           ▼
          ┌────────────────────────────────┐
          │          Prometheus            │
          │            v3.7.3              │
          │                                │
          │  ┌──────────────────────────┐  │
          │  │     Scrape Targets       │  │
          │  │  - /metrics endpoints    │  │
          │  │  - ServiceMonitor CRD    │  │
          │  └──────────────────────────┘  │
          └────────────────┬───────────────┘
                           │
          ┌────────────────┼────────────────┐
          │                │                │
          ▼                ▼                ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│   Thanos    │   │   Grafana   │   │  InfluxDB2  │
│  (Sidecar)  │   │   v12.3.0   │   │  (長期保存)  │
│   v0.40.1   │   └─────────────┘   │    50Gi     │
└─────────────┘                     └─────────────┘
```

### メトリクス収集対象

| Exporter | メトリクス種別 | 収集間隔 |
|----------|--------------|---------|
| Node-Exporter | CPU, Memory, Disk, Network | 15s |
| kube-state-metrics | Pod, Deployment, Node状態 | 15s |
| Remo-Exporter | 温度, 湿度, 照度 (Nature Remo) | 60s |

### Grafana ダッシュボード

1. **Node-Exporter**: ノードリソース監視
2. **Remo-Exporter**: スマートホーム環境監視
3. **Proxmox-Flux**: 仮想化基盤監視

## 証明書更新フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                    cert-manager Flow                             │
│                                                                  │
│  ┌─────────────────┐                                            │
│  │   Certificate   │  ワイルドカード証明書リクエスト               │
│  │     CRD         │  *.harvestasya.org                         │
│  └────────┬────────┘                                            │
│           │                                                      │
│           ▼                                                      │
│  ┌─────────────────┐     ┌─────────────────┐                    │
│  │  cert-manager   │────▶│   Cloudflare    │                    │
│  │   Controller    │     │    DNS API      │                    │
│  └────────┬────────┘     └─────────────────┘                    │
│           │                      │                               │
│           │              DNS-01 Challenge                        │
│           │                      │                               │
│           │              ┌───────▼───────┐                       │
│           │              │  Let's Encrypt│                       │
│           │              │     ACME      │                       │
│           │              └───────┬───────┘                       │
│           │                      │                               │
│           │◀─────── Certificate ─┘                               │
│           │                                                      │
│           ▼                                                      │
│  ┌─────────────────┐                                            │
│  │   Kubernetes    │  TLSシークレット作成/更新                    │
│  │     Secret      │                                            │
│  └─────────────────┘                                            │
└─────────────────────────────────────────────────────────────────┘
```

## データベースアクセスフロー

```
┌─────────────────────────────────────────────────────────────────┐
│                  CloudNative PostgreSQL                          │
│                                                                  │
│  ┌───────────────┐                                              │
│  │  Application  │  (Immich, n8n)                               │
│  │     Pod       │                                              │
│  └───────┬───────┘                                              │
│          │                                                       │
│          │ PostgreSQL Protocol                                   │
│          ▼                                                       │
│  ┌───────────────┐     ┌───────────────────────────────────┐    │
│  │  CNPG Cluster │────▶│  Primary PostgreSQL Instance      │    │
│  │   Service     │     │                                   │    │
│  └───────────────┘     │  ┌─────────────────────────────┐  │    │
│                        │  │  VectorChord Extension      │  │    │
│                        │  │  (Immich ベクトル検索用)      │  │    │
│                        │  └─────────────────────────────┘  │    │
│                        └───────────────┬───────────────────┘    │
│                                        │                         │
│                                        │ WAL Archive             │
│                                        ▼                         │
│                        ┌───────────────────────────────────┐    │
│                        │         NFS Storage               │    │
│                        │   (Point-in-Time Recovery用)       │    │
│                        └───────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

## HTTPリクエストフロー

### 外部アクセス (Cloudflare Tunnel)

```
User ──▶ Cloudflare Edge ──▶ CF Tunnel ──▶ CF Tunnel Controller ──▶ Service ──▶ Pod
```

### 外部アクセス (Traefik Direct)

```
User ──▶ Cloudflare Proxy ──▶ Traefik Ingress ──▶ Service ──▶ Pod
                                    │
                                    ▼
                            [Middleware Chain]
                            - security-headers
                            - authentik-forward-auth (optional)
                            - compress
```

### 内部通信

```
Pod A ──▶ Service (ClusterIP) ──▶ Pod B
```

## バックアップフロー

```
┌─────────────────────────────────────────────────────────────────┐
│                      Backup Strategy                             │
│                                                                  │
│  ┌─────────────────┐                                            │
│  │  PostgreSQL     │                                            │
│  │  (CNPG)         │                                            │
│  └────────┬────────┘                                            │
│           │                                                      │
│           │ Continuous WAL Archiving                             │
│           ▼                                                      │
│  ┌─────────────────┐                                            │
│  │   NFS Storage   │  Point-in-Time Recovery 対応                │
│  └─────────────────┘                                            │
│                                                                  │
│  ┌─────────────────┐                                            │
│  │  Application    │                                            │
│  │  Data (Immich)  │                                            │
│  └────────┬────────┘                                            │
│           │                                                      │
│           │ Direct Write                                         │
│           ▼                                                      │
│  ┌─────────────────┐                                            │
│  │   NFS Volume    │  外部ストレージでのバックアップ               │
│  │   (100Gi)       │                                            │
│  └─────────────────┘                                            │
└─────────────────────────────────────────────────────────────────┘
```
