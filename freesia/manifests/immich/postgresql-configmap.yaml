apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-config
  namespace: immich
  labels:
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: immich
data:
  POSTGRES_DB: immich
  POSTGRES_USER: immich
  # 初期化スクリプト
  init-extensions.sh: |-
    #!/bin/bash
    set -e

    echo "Waiting for PostgreSQL to be ready..."
    until pg_isready -U postgres; do
      sleep 2
    done

    echo "Creating extensions..."
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
      CREATE EXTENSION IF NOT EXISTS vectorchord CASCADE;
      CREATE EXTENSION IF NOT EXISTS pgvector CASCADE;
      CREATE EXTENSION IF NOT EXISTS earthdistance CASCADE;
      CREATE EXTENSION IF NOT EXISTS cube CASCADE;
    EOSQL

    echo "Extensions created successfully"
