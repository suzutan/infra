image:
  registry: public.ecr.aws/docker/library

deployment:
  replicas: 1
  dnsPolicy: ClusterFirstWithHostNet

# type:LoadBalancerを使わずにingressを解放するためhostNetworkをtrueにする
hostNetwork: true
# hostNetwork:true で80,443がPermission Deniedな状態になるのを対応するためにsecurityContextを定義する
# https://stackoverflow.com/questions/66138370/permission-problem-w-helm3-installation-of-traefik-on-port-80-hostnetwork
securityContext:
  capabilities:
    drop: [ALL]
    add: [NET_BIND_SERVICE]
  readOnlyRootFilesystem: true
  runAsGroup: 0
  runAsNonRoot: false
  runAsUser: 0
updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 1 # hostNetworkでportを解放しないといけないのでダウンを許容する
    maxSurge: 1

envFrom:
- configMapRef:
    name: traefik-env

# experimental:
#   plugins:
#     cloudflarewarp:
#       moduleName: github.com/BetterCorp/cloudflarewarp
#       # renovate: datasource=github-tags depName=BetterCorp/cloudflarewarp
#       version: v1.3.3

ingressClass:
  enabled: true
  isDefaultClass: true

providers:
  kubernetesCRD:
    allowCrossNamespace: true
    allowEmptyServices: true
    allowExternalNameServices: true
    enabled: true
  kubernetesIngress:
    enabled: false

service:
  type: ClusterIP

globalArguments: []

ingressRoute:
  dashboard:
    enabled: false

ports:
  web: null
  websecure:
    port: 443
    asDefault: true
    expose:
      default: true
    exposedPort: 443
    forwardedHeaders:
      trustedIPs:
      - 10.0.0.0/16
    middlewares:
    - traefik-security-headers@kubernetescrd
    - traefik-ban-robots@kubernetescrd
    tls:
      enabled: true
      # this is the name of a TLSOption definition
      options: ""
      domains:
      - main: harvestasya.org
        sans:
        - "*.harvestasya.org"
        - "*.suzutan.jp"
  metrics:
    # -- When using hostNetwork, use another port to avoid conflict with node exporter:
    # https://github.com/prometheus/prometheus/wiki/Default-port-allocations
    port: 9101




# https://docs.traefik.io/observability/logs/
logs:
  access:
    enabled: true
    # https://docs.traefik.io/observability/access-logs/#limiting-the-fieldsincluding-headers
    fields:
      general:
        defaultmode: keep
        names:
          ClientAddr: drop
          DownstreamContentSize: drop
          DownstreamStatus: drop
          OriginDuration: drop
          Overhead: drop
          RequestCount: drop
          RequestHost: drop
          RequestPort: drop
          RetryAttempts: drop
          ServiceAddr: drop
          ServiceName: drop
          ServiceURL: drop
          StartLocal: drop
          StartUTC: drop
      headers:
        defaultmode: drop
        names:
          Cf-Ipcountry: keep
          Cf-Ray: keep
          Cf-Visitor: keep
          Location: keep
          User-Agent: keep
    format: json
  general:
    level: INFO
