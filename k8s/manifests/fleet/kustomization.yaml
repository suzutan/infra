apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: fleet
resources:
- namespace.yaml
- external-secret.yaml
- pomerium-ingress.yaml
- ingressroute.yaml
helmCharts:
- name: fleet
  releaseName: fleet
  repo: https://fleetdm.github.io/fleet/charts
  valuesFile: values.yaml
- name: mysql
  releaseName: mysql
  version: 12.3.2
  repo: oci://registry-1.docker.io/bitnamicharts
  valuesInline:
    auth:
      database: fleet
      username: fleet
      existingSecret: fleet-mysql-secret
    global:
      imageRegistry: public.ecr.aws
      security:
        allowInsecureImages: true
    primary:
      configuration: |-
        [mysqld]
        innodb_use_native_aio=0
      startupProbe:
        enabled: true
        initialDelaySeconds: 30
        periodSeconds: 15
        failureThreshold: 30
      extraEnvVars:
      - name: TZ
        value: Asia/Tokyo
      persistence:
        enabled: true
        storageClass: nfs-client
        size: 10Gi
      resources:
        limits:
          cpu: "1"
          memory: 2Gi
        requests:
          cpu: 250m
          memory: 512Mi
- name: valkey
  releaseName: valkey
  version: 5.4.3
  repo: oci://registry-1.docker.io/bitnamicharts
  valuesInline:
    architecture: standalone
    auth:
      existingSecret: fleet-valkey-secret
    global:
      imageRegistry: public.ecr.aws
      security:
        allowInsecureImages: true
    primary:
      extraEnvVars:
      - name: TZ
        value: Asia/Tokyo
      persistence:
        enabled: true
      resourcesPreset: nano
patches:
# Remove Helm hook annotations - autoApplySQLMigrations handles migrations
- target:
    kind: Job
    name: fleet-migration
  patch: |-
    - op: remove
      path: /metadata/annotations/helm.sh~1hook
    - op: remove
      path: /metadata/annotations/helm.sh~1hook-delete-policy
    - op: remove
      path: /metadata/annotations/helm.sh~1hook-weight
- target:
    kind: ServiceAccount
    name: fleet
    annotationSelector: helm.sh/hook
  patch: |-
    - op: remove
      path: /metadata/annotations/helm.sh~1hook
    - op: remove
      path: /metadata/annotations/helm.sh~1hook-delete-policy
    - op: remove
      path: /metadata/annotations/helm.sh~1hook-weight
- target:
    kind: Role
    name: fleet
    annotationSelector: helm.sh/hook
  patch: |-
    - op: remove
      path: /metadata/annotations/helm.sh~1hook
    - op: remove
      path: /metadata/annotations/helm.sh~1hook-delete-policy
    - op: remove
      path: /metadata/annotations/helm.sh~1hook-weight
- target:
    kind: RoleBinding
    name: fleet
    annotationSelector: helm.sh/hook
  patch: |-
    - op: remove
      path: /metadata/annotations/helm.sh~1hook
    - op: remove
      path: /metadata/annotations/helm.sh~1hook-delete-policy
    - op: remove
      path: /metadata/annotations/helm.sh~1hook-weight
# Sync wave: ExternalSecrets first (secrets must exist before DB/cache start)
- target:
    kind: ExternalSecret
  patch: |-
    - op: add
      path: /metadata/annotations/argocd.argoproj.io~1sync-wave
      value: "-1"
# Inject FLEET_SERVER_PRIVATE_KEY from secret into Fleet deployment
- target:
    kind: Deployment
    name: fleet
  patch: |-
    - op: add
      path: /spec/template/spec/containers/0/envFrom
      value:
      - secretRef:
          name: fleet-server-secret
