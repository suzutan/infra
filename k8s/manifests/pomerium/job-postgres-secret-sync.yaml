apiVersion: v1
kind: ServiceAccount
metadata:
  name: postgres-secret-sync
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: postgres-secret-sync
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: postgres-secret-sync
subjects:
- kind: ServiceAccount
  name: postgres-secret-sync
roleRef:
  kind: Role
  name: postgres-secret-sync
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-secret-sync
  annotations:
    argocd.argoproj.io/hook: PostSync
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: postgres-secret-sync
      containers:
      - name: sync
        image: bitnami/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Waiting for CNPG secret..."
          until kubectl get secret pomerium-pg-app 2>/dev/null; do
            sleep 5
          done
          echo "Syncing secret..."
          URI=$(kubectl get secret pomerium-pg-app -o jsonpath='{.data.uri}' | base64 -d)
          kubectl create secret generic pomerium-postgres \
            --from-literal=connection="$URI" \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "Done!"
      restartPolicy: OnFailure
      nodeSelector:
        kubernetes.io/os: linux
